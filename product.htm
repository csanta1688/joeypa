<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="JPlogo.ico">
<title>茂果科技產品總覽</title>

<style>
:root{
  --side-bg:#8080ff;
  --side-hover:#FFFF99;
  --side-text:#ffffff;
  --content-bg:#ffffff;

  --title-bg:#6f6fff;
  --title-border:#9a9aff;
}

html,body{
  height:100%;
  margin:0;
  background:var(--content-bg);
  font-family:"Microsoft JhengHei","Meiryo","Hiragino Kaku Gothic ProN",Arial,sans-serif;
}

#layout{
  display:flex;
  height:100vh;
  overflow:hidden;
}

#sidebar{
  width:180px;
  background:var(--side-bg);
  color:var(--side-text);
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:0;
  gap:8px;
}

#sidebar .vtitle{
  width:100%;
  height:52px;
  box-sizing:border-box;
  background:var(--title-bg);
  border-bottom:1px solid var(--title-border);
  display:flex;
  align-items:center;
  justify-content:center;
  writing-mode:horizontal-tb;
  white-space:nowrap;
  color:#fff;
  font-weight:bold;
  font-size:14px;
  letter-spacing:1px;
  user-select:none;
}

#sidebar .btn{
  width:160px;
  background:#ffffff;
  color:#8080ff;
  border:0;
  cursor:pointer;
  font-size:12px;
  padding:8px 0;
}

#sidebar .btn:first-of-type{ margin-top:8px; }
#sidebar .btn:hover{ background:var(--side-hover); }
#sidebar .btn.active{ background:var(--side-hover); font-weight:bold; }

#main{
  flex:1;
  overflow:auto;
}
#contentArea{
  min-height:100%;
}
</style>

<!-- Google 翻譯：母頁統一管理，子頁不重複載入 -->
<div id="google_translate_element" style="display:none"></div>
<script>
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage:'zh-TW', autoDisplay:false}, 'google_translate_element');
}
</script>
<script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script>
/* =========================
   子頁載入器修正版（強化：永遠不跳出 product.htm 框架）
   - 注入子頁 head 的 style/link
   - 修正子頁內相對路徑 (img/src, a/href, background url)
   - 修正 JBC1208M 縮圖切換會把 src 改回相對路徑的問題
   - ★新增：contentArea capture 導頁攔截器（避免點 GO 跳出框架）
   ========================= */

const DYN_ATTR = "data-dyn-asset";

/** 清掉上一個子頁注入的 style/link（避免污染） */
function resetDynHead(){
  document.head.querySelectorAll(`style[${DYN_ATTR}],link[rel="stylesheet"][${DYN_ATTR}]`).forEach(n=>n.remove());
}

function isAbs(u){
  return /^(https?:)?\/\//i.test(u) || /^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(u) || u.startsWith("/");
}
function resolve(u, base){
  try { return new URL(u, base).href; } catch(e) { return u; }
}

/** 修正內容區內的相對路徑：src/href/poster + style url(...) */
function rewriteRelatives(root, baseUrl){
  root.querySelectorAll("[src],[href],[poster]").forEach(el=>{
    ["src","href","poster"].forEach(attr=>{
      if(!el.hasAttribute(attr)) return;
      const v = el.getAttribute(attr);
      if(!v) return;
      if(v.startsWith("#")) return;
      if(/^javascript:/i.test(v)) return;
      if(/^(mailto:|tel:|data:|blob:)/i.test(v)) return;
      if(!isAbs(v)){
        el.setAttribute(attr, resolve(v, baseUrl));
      }
    });
  });

  root.querySelectorAll("[style]").forEach(el=>{
    const s = el.getAttribute("style") || "";
    const fixed = s.replace(/url\((['"]?)([^'")]+)\1\)/gi, (m,q,u)=>{
      const uu = (u||"").trim();
      if(!uu) return m;
      if(isAbs(uu) || uu.startsWith("#") || /^(data:|blob:)/i.test(uu)) return m;
      return `url("${resolve(uu, baseUrl)}")`;
    });
    if(fixed !== s) el.setAttribute("style", fixed);
  });
}

/** 注入子頁 head 的 style/link 到母頁 */
function injectHeadAssets(doc, baseUrl){
  resetDynHead();

  doc.querySelectorAll("head style").forEach(st=>{
    const n = document.createElement("style");
    n.setAttribute(DYN_ATTR,"1");
    n.textContent = st.textContent || "";
    document.head.appendChild(n);
  });

  doc.querySelectorAll('head link[rel="stylesheet"][href]').forEach(ln=>{
    const n = document.createElement("link");
    n.rel = "stylesheet";
    n.setAttribute(DYN_ATTR,"1");
    n.href = resolve(ln.getAttribute("href"), baseUrl);
    document.head.appendChild(n);
  });
}

/** 子頁腳本：只執行 inline（避免重複載入 translate element.js）
    注意：JBC1208M 的縮圖行為我不靠執行它的 script，而是用下面的相容層接管 src */
function runInlineScripts(doc, mountEl){
  doc.querySelectorAll("script").forEach(s=>{
    const src = s.getAttribute("src");
    const code = (s.textContent || "").trim();

    // 不重複載入 Google 翻譯 element.js
    if(src && /translate\.google\.com\/translate_a\/element\.js/i.test(src)) return;
    // 避免覆寫母頁翻譯 init
    if(code && /googleTranslateElementInit|translate_a\/element\.js/i.test(code)) return;

    // 只執行 inline（保守、安全；外部 script 若你有需要可再加）
    if(!src && code){
      const ns = document.createElement("script");
      ns.textContent = code;
      mountEl.appendChild(ns);
    }
  });
}

/** JBC1208M 縮圖相容層：
    - 原子頁 script 會做 mainImage.src = id + ".jpg"（相對路徑）
    - 內嵌時會裂圖，所以在捕捉階段攔截 click，改成絕對路徑
    - ★關鍵修正：阻止子頁原本 click handler 執行，避免把大圖 src 改回相對路徑
*/
function attachGalleryCompat(area, pageUrl){
  const strip = area.querySelector("#thumbStrip");
  const mainImg = area.querySelector("#mainImage");
  if(!strip || !mainImg) return;

  const baseDir = new URL(".", pageUrl).href; // 例如 .../ppf/JBC1208M/

  function setActive(btn){
    const buttons = strip.querySelectorAll(".thumb-btn");
    buttons.forEach(b => b.setAttribute("aria-current", "false"));
    btn.setAttribute("aria-current", "true");
  }

  strip.addEventListener("click", (e)=>{
    const btn = e.target.closest(".thumb-btn");
    if(!btn) return;
    const id = btn.getAttribute("data-id");
    if(!id) return;

    // 直接指定絕對路徑，避免相對路徑回退
    mainImg.src = resolve(id + ".jpg", baseDir);
    mainImg.alt = id + " 原圖 (320x240)";
    setActive(btn);

    // ★阻止子頁原本的 click handler（它會把 src 改回相對路徑）
    e.preventDefault();
    e.stopPropagation();
    if (e.stopImmediatePropagation) e.stopImmediatePropagation();
  }, true); // 捕捉階段：先於子頁原本 handler
}

/** ★重點：在 contentArea 以 capture 攔截所有站內 .htm/.html 導頁，確保永遠不跳出 product.htm */
function installContentNavInterceptor(area){
  if(area.__navInterceptorInstalled) return;
  area.__navInterceptorInstalled = true;

  area.addEventListener("click", function(e){
    const a = e.target.closest && e.target.closest("a[href]");
    if(!a) return;

    const hrefRaw = a.getAttribute("href");
    if(!hrefRaw) return;

    // 允許：錨點 / JS / mailto / tel / data / blob
    if(hrefRaw.startsWith("#")) return;
    if(/^javascript:/i.test(hrefRaw)) return;
    if(/^(mailto:|tel:|data:|blob:)/i.test(hrefRaw)) return;

    // 若是外站 http(s)，放行
    if(/^(https?:)?\/\//i.test(hrefRaw) && !hrefRaw.startsWith(location.origin)) return;

    // 只攔 .htm/.html（你站內都是這種）
    const abs = resolve(hrefRaw, area.__currentPageUrl || location.href);
    const isHtml = /\.html?(\?|#|$)/i.test(abs);
    const sameOrigin = abs.startsWith(location.origin);

    if(sameOrigin && isHtml){
      e.preventDefault();
      e.stopPropagation();
      loadIntoContent(abs);
    }
  }, true); // capture：先攔截，避免預設導頁跳出框架
}

async function loadIntoContent(url){
  // 這裡一定要把 url 變成絕對，否則多層相對路徑會錯
  const pageUrl = new URL(url, location.href).href;

  const res = await fetch(pageUrl, {cache:"no-store"});
  const html = await res.text();
  const doc = new DOMParser().parseFromString(html, "text/html");

  // 1) 注入子頁 head 的 style/link（CSS 才會恢復）
  injectHeadAssets(doc, pageUrl);

  // 2) 塞子頁 body
  const area = document.getElementById("contentArea");
  area.innerHTML = doc.body ? doc.body.innerHTML : html;

  // 記錄目前子頁 URL（供攔截器用作 base）
  area.__currentPageUrl = pageUrl;

  // ★先安裝全域攔截器（只裝一次）
  installContentNavInterceptor(area);

  // 3) 修正相對路徑（圖片、連結、背景）
  rewriteRelatives(area, pageUrl);

  // 4) 強制內容區所有連結 target=_self（避免另開或跳出框架）
  area.querySelectorAll("a").forEach(a=>{
    a.setAttribute("target","_self");
    a.removeAttribute("download");
  });

  // 5) 執行必要 inline scripts（若子頁有用到）
  runInlineScripts(doc, area);

  // 6) 特別修正：JBC1208M 縮圖點擊後 src 會回相對路徑導致裂圖
  attachGalleryCompat(area, pageUrl);
}

function setActive(id){
  document.querySelectorAll("#sidebar .btn").forEach(b=>b.classList.remove("active"));
  const b = document.getElementById(id);
  if(b) b.classList.add("active");
}
function go(url, btnId){
  setActive(btnId);
  loadIntoContent(url);
}

window.addEventListener("DOMContentLoaded", ()=>{
  go("product_charger.htm","btn_charger");
});
</script>

</head>
<body>
<div id="layout">
  <div id="sidebar">
    <div class="vtitle">產品類型</div>

    <button class="btn" id="btn_home" onclick="location.href='main.htm'">回主頁</button>
    <button class="btn" id="btn_charger" onclick="go('product_charger.htm','btn_charger')">電瓶充電器(室內用)</button>
    <button class="btn" id="btn_inverter" onclick="go('product_inverter.htm','btn_inverter')">電源轉換器</button>
    <button class="btn" id="btn_isolator" onclick="go('product_isolator.htm','btn_isolator')">電瓶隔離器</button>
    <button class="btn" id="btn_other" onclick="go('product_other.htm','btn_other')">相關附件</button>
  </div>

  <div id="main">
    <div id="contentArea"></div>
  </div>
</div>
</body>
</html>
<!-- DEPLOY_MARK: 2026-01-21-joeypa -->
<!-- DEPLOY_MARK: 2026-01-21-joeypa -->
